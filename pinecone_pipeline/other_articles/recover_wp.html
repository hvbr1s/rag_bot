<!DOCTYPE html>
<html>
<head>
	<meta content="https://github.com/LedgerHQ/recover-whitepaper" name="source"/>
	<meta content="white paper" name="source-type"/>
	<meta content="en-us" name="locale"/>
	<meta content="N/A" name="zd-article-id"/>
	<meta content="Ledger Recover Technical White Paper" name="title"/>
	<meta content="public" name="classification"/>
	<title>Ledger Recover Technical White Paper</title>
</head>
<body>
	<p>
	Introduction Welcome to this technical white paper, a deep dive into the system design, architecturalfeatures, and operational ﬂows of Ledger Recover. As an advanced solution for the backupand restoration of your device seed, Ledger Recover encapsulates a series of robustcryptographic protocols, purpose-built to deliver an unparalleled combination of security,resiliency, and user-centricity.In this document, we'll be revealing the foundational design and key security targets of theunderlying cryptographic protocol employed by Ledger Recover. This will involve insightsinto the system's structural layout, as well as a broader view of its primary design andsecurity objectives. Our aim is to provide you with a clear understanding of the intricatemechanisms behind Ledger Recover, showcasing the unique measures incorporated toprotect and uphold the integrity of your data.We'll also take a close look at the three main operational ﬂows of Ledger Recover – backingup your seed, restoring it on a new device, and securely deleting your backups. Theseprocedures form the backbone of Ledger Recover's functionality, each one thoughtfullydesigned to ensure an eﬃcient, user-friendly experience without compromising on thesystem's high level of security.By the end of this white paper, we anticipate providing you with an enriched understandingof Ledger Recover's system design, cryptographic protocol, and its three primaryfunctionalities. Whether you're a seasoned professional in the ﬁeld or a newcomer, wetrust that the insights provided will help you better understand Ledger Recover andhighlight its value in secure data backup and restoration in the ever-evolvingcryptocurrency world
	
	
	System Design OverviewThe overall design of Ledger Recover is quickly presented in the following diagram.The two most important components are on one hand, the devices, hardware walletscontaining a Secure Element and a trusted display allowing safe manipulation of the seed;and on the other hand the backup providers, especially their Hardware Security Module,securing all the cryptographic exchanges introduced in this paper.Secure Elements (SEs) and Hardware Security Modules (HSMs) are integral components inthe ﬁeld of information security that provide secure storage and operations for sensitivedata. A SE is a tamper-resistant platform that can host applications and their conﬁdentialand cryptographic data securely. It's commonly found in small form-factor devices such assmart cards, mobile phones, and IoT devices. On the other hand, an HSM is a physicaldevice that safeguards and manages digital keys for crypto processing and trustedexecution of code. It prevents unauthorized access to sensitive material and is often usedin a server-type environment for critical operations such as managing SSL/TLS digital keysfor website security, transaction processing, identity management, and databaseencryption. Both SEs and HSMs deliver enhanced security by ensuring that sensitive data isstored and processed within a secure and trusted environment.One of the main ways to evaluate secure hardware is through security certiﬁcations. Ledgerdevices are using Common Criteria certiﬁed secure elements and backup providersHardware Security Modules are FIPS 140–2 certiﬁed. You can ﬁnd the models andcertiﬁcates in the following table.Secure HardwareModelCertiﬁcateNano SST31H320EAL 5+Nano S plusST33K1M5EAL 6+Nano XST33J2M0EAL 5+Recover HSMsThales ProtectServerFIPS 140-2 Level 3
	
	
	Other notable components in the system are:● The Orchestrator makes sure all messages transit correctly and in the right orderbetween all other components: it is not critical for the security of the system butimportant for getting the best UX possible● Ledger Live is the main user interface for interacting with Recover, on both mobileand desktop● IDV Providers are our partners providing the Identity Veriﬁcation service required bythe current design for strongly authenticating users when trying to backup andrestore● Stargate and Chargebee are our account and subscription services
	
	Design Goals The protocol is intended to be secured end-to-end between the devices and the HSMs ofthe backup providers, so no intermediate systems or actors - Ledger Live, orchestrator oran attacker - can read sensitive information shared between the backup providers HSMsand the devices.The protocol is designed to support the following set of properties.Self-Custody● The seed is split into shares using a variant of Shamir Secret Sharing so that nobackup provider touches, controls or sees the full seed. Having less than therequired number of shares does not give any information on the seed.● The seed is encrypted (using AES 256 CBC with a key common to all devices) to aciphertext that reveals nothing about the seed (in the same way that a signatureproduced by a key does not reveal anything on the key). The ciphertext is then splitusing SSS. This limits collusion risks from backup providers.Resilience● Splitting uses a 2-out-of-3 scheme so that seed can still be restored even if a singlebackup provider loses a share.● Strong cryptographic commitments on share generation allows providing safebackup guarantees without leaking data on shares.Share transport security● End-to-end encryption to a known recipient with strong forward secrecy.● Shares are encrypted based on an elliptic curve Diﬃe-Hellman key exchange -ephemeral with an authenticated party.● Assuming the ephemeral private keys are secure, and the recipient is not beingactively impersonated by an attacker that has stolen its static private key, the sharecannot be decrypted by an intermediary.Share storage security● End recipient of a share is a Hardware Security Module, setup by each backupprovider. A share provisioned to an HSM cannot be extracted, even by the HSMadmin. It can only be extracted using a properly executed restore ﬂow All shares and all user attributes in the protocol stored by backup providers areencrypted by an encryption key that never leaves the backup provider HSM.● Identiﬁers of backups are diversiﬁed to avoid easy correlation between databases,with a diversiﬁcation key that never leaves the backup provider HSM.● All cryptographic operations are done within the conﬁnes of the HSM and areatomic.Session bindings● To avoid session swapping and replays by an attacker, all sessions between device,orchestrator, providers and IDVs are bound together at the crypto protocol level.● Identity data is bound by devices to backup and restore sessions.● Restore Sessions are hard locked to a device.● IDV session is bound to restore session through use of a One Time Security Code,derived from the shared key between device and backup provider.Proof of correctness● The backup provider proves that it was able to decrypt the seed-share.● Orchestrator is able to cryptographically verify that each share has been transmittedsecurely, without leaking info on the shares.Privacy preserving● Orchestrator: Static public key is transmitted in clear.● Backup provider: Static public key is encrypted with forward secrecy to anauthenticated party. Spying exchanges won’t leak the provider identity.● Device: Static public key is encrypted with forward secrecy to an authenticated party.Spying exchanges won’t leak the device identity.Small number of exchanges● Only three messages (backup) or four messages (restore) need to be exchangedbetween the device and a single provider.● Can be reduced by one message if the proof of reception of the seed-share is notrequired.Ledger independent● An (expert) user can replace Ledger as a trusted root and run the protocol togenerate encrypted shares completely independently from Ledger. Seed generationLedger devices are generating the seed and the seed recovery phrase using BIP 39. Asummary is provided below for reference. An initial entropy is generated from the device True Random Number Generator. Theentropy is either 128 bits for a 12-word seed recovery phrase or 256 bits for a 24-word one.Note that when generating entropy on a device, Ledger only uses the longer and stronger256 bits version.A checksum is then added to the entropy, by taking the ﬁrst length_in_bits / 32 bits ofthe SHA-256 hash of the entropy. The checksum is appended to the entropy, and the resultis split into groups of 11 bits, which serves as an index into an array of 2048 words (part ofthe BIP39 speciﬁcation). The list of words is collectively known as the seed recovery phrase,or the “mnemonic”.To create a binary seed from the mnemonic, we use the PBKDF2 function with a mnemonicsentence (in UTF-8 NFKD) used as the password and the string "mnemonic" + passphrase(again in UTF-8 NFKD) used as the salt. The iteration count is set to 2048 and HMAC-SHA512is used as the pseudo-random function. The length of the derived key is 512 bits (= 64bytes).This seed can be later used to generate deterministic wallets using BIP-0032 or similarmethods.In Ledger Recover, what gets encrypted then split using Pedersen Shamir Secret Sharing isthe initial entropy itself. When restoring the seed, the BIP 39 algorithm will be applied tothe recombined entropy to restore the seed of the user. 
	
	Backup The backup ﬂow is divided in three main stages:● Enroll stage: the user will enroll to recover, subscribe and perform a ﬁrst IDV, thisstage is out of scope of the current white paper, it is assumed the orchestrator has atrusted identity out of it.● Secure Channel Setup: the secure channels are established between device andbackup providers (and orchestrator), bound together and to the identity data.● Shares backup: once the user approves the identity on device, shares are computed,commitments exchanged in both directions (proving shares are generated,consistent along the way and stored correctly) and ids computed for the deletephase
	
	Restore The Restore ﬂow has ﬁve main stages:Trigger stage: the user will authenticate and trigger a restore on a new device. Thisstage is out of scope of this document● Secure Channels Setup: as for backup, the secure channels are established betweendevice and backup providers (and orchestrator), bound together and to the identitydata
	● OTSC generation: a One Time Security Code is generated from the secure channelitself on both device and backup provider side, and will be used for binding IDVsession● Identity Veriﬁcation: the user is redirected to and will perform two distinct IdentityVeriﬁcation with two diﬀerent IDV providers (in current implementation, Tessi andOnFido)● Restore seed stage: After verifying the IDV results, the backup providers will releasethe shares to the new device over secure channels. The device will recombine theshares into the encrypted seed and decrypt the seed to restore functions.
	
	Delete The Delete ﬂow is used to delete a seed’s shares backups securely, by proving that a userhas a real device with the corresponding seed initialized (so deleting the backup won’t leavethe funds potentially unreachable).A Deletion ﬂow has three main stage:● Trigger stage: the user authenticates to Ledger Recover, and triggers a secureshares deletion. This is out of scope of this paper.● Secure Channel Setup: the secure channels are established between device andbackup providers (and orchestrator), bound together and to the identity data.Challenges are exchanged between backup providers and the device.● Shares deletion: Challenges are signed and exchanged to prove the seed on thedevice is the right one. Shares are deleted once checked.
	
	A Note on Identity Veriﬁcation Identity Veriﬁcation as an authentication mechanismThe underlying assumption for choosing Identity Veriﬁcation as an authenticationmechanism, is that Ledger Recover is intended as a service used for Disaster Recovery: asituation in which our customer has lost access to potentially all his devices (wallets, PCs orphones), lost his PINs, email passwords and all traditional electronic veriﬁcation forms.In this context, the legal citizen identity is the only form of strong authentication that canbe reconstructed from scratch and a good basis for an authentication in case of massivefailure of everything else.During the backup process, it’s enough to perform only one IDV because the user is goingto conﬁrm their identity on the device before exporting the shares.However, each backup provider should perform an independent IDV during the restore.The rationale is that it would be harder for an attacker to compromise multiple IDV servicesinstead of one. There are two possible attacks:● The attacker is able to fool the identity veriﬁcation and impersonate the user.● The attacker is able to bypass the IDV process and send the expected IDV data tothe Backup Providers without verifying their identity.Both attacks are harder if we use multiple IDV services during the restore, which is themost critical step since it can lead to the loss of funds.StepNumber of IDVsBackup1Restore1 per backup provider
	
	Backup/Restore data The backup & restore data, extracted from IDVs and veriﬁed on the device during bothbackup and restore ﬂows, is designed to hold a pivotal identity: the minimal set of attributesthat uniquely and legally identify a physical person.Most governments have a way to restore or create a legal identity document from provingphysically this set of attributes in person.AttributeDescriptionFirst NameAll legal ﬁrst names of the person, as seenon ID documentsLast NameLegal last name as seen on ID documentsDate of BirthLegal date of birthPlace of BirthFull name of the place of birthNote that the corresponding ﬁelds in the protocol contain the full representation of theseattributes even if the device itself is not able to display them fully.
	
	Conclusion In conclusion, the Ledger Recover cryptographic protocol provides a robust, secure, andeﬃcient system for backing up and restoring a device seed. With its end-to-end encryption,non-repudiation characteristics, privacy measures, and minimalistic yet eﬀective design, itensures a secure environment for data operations. The resilience provided by the2-out-of-3 scheme and the Shamir Secret Sharing variant, coupled with the high degree ofshare transport and storage security, makes this protocol not only resistant to potentialthreats but also adaptable to various scenarios.Moreover, the ability for expert users to run the protocol independently from Ledgerunderscores its ﬂexibility and commitment to self-custody. These unique featurescollectively aﬃrm the Ledger Recover cryptographic protocol as a comprehensive solutionfor device seed backup and restoration. Its innovative strategies stand as a testament tothe potential of cryptographic technology, providing a reliable and user-centric choice inthe ever-evolving digital landscape.
	</p>
</body>
</html>